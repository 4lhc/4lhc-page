<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Controlling ROS Turtlebot3 with Miband - Part I | Sreejith Sasidharan</title> <meta name="author" content="Sreejith Sasidharan"/> <meta name="description" content="Reading raw accelerometer data from a Xiaomi Miband for controllling a ROS Gazebo Turtlebot3 simulation."/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‡¸</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://sreejiths.xyz/blog/2019/controlling-ROS-robot-with-miband-hrx-1/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://sreejiths.xyz/"><span class="font-weight-bold">Sreejith</span> Sasidharan</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Controlling ROS Turtlebot3 with Miband - Part I</h1> <p class="post-meta">September 5, 2019</p> <p class="post-tags"> <a href="/blog/2019"> <i class="fas fa-calendar fa-sm"></i> 2019 </a> Â  Â· Â  <a href="/blog/tag/ros"> <i class="fas fa-hashtag fa-sm"></i> ros</a> Â  <a href="/blog/tag/ble"> <i class="fas fa-hashtag fa-sm"></i> ble</a> Â  Â  Â· Â  <a href="/blog/category/ros"> <i class="fas fa-tag fa-sm"></i> ros</a> Â  </p> </header> <article class="post-content"> <p>I wanted to control my Turtlebot3 gazebo simulations using the Xiaomi MiBand HRX. MiBand uses Bluetooth Low Energy for communication. The major challenge in trying to interface the MiBand HRX with ROS, was understanding the undocumented services and characteristics. Fortunately, there are several python libraries that are written for MiBand2 &amp; 3 models. So, I didnâ€™t have to start from scratch!</p> <p>Still, the challenge of finding the right services &amp; values remained. I started by forking <a href="https://github.com/creotiv/MiBand2" target="_blank" rel="noopener noreferrer">this</a> wonderful library by creotiv which used bluepy. I was only interested in reading the accelerometer data.</p> <p>Check out the repo <a href="">here</a>.</p> <p>So, letâ€™s begin by identifying the MAC address of the MiBand!</p> <h3 id="1-ble---connecting-and-reading-data">1. BLE - connecting and reading data</h3> <p>An excellent place to learn about BLE GATT Services and Characteristics would be <a href="https://www.oreilly.com/library/view/getting-started-with/9781491900550/ch04.html" target="_blank" rel="noopener noreferrer">here</a>.</p> <h4 id="scan-for-available-devices">Scan for available devices</h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>hcitool lescan
</code></pre></div></div> <p>The following commands were helpful in identification of services and characteristics specific to HRX bands. Xiaomi doesnâ€™t provide user descriptions for the services and characteristics, which makes it harder. There are plenty of reverse engineered solutions for MiBand2 &amp; 3 which are extremely <a href="#sources--references">helpful</a>.</p> <h4 id="list-services">List services</h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gatttool <span class="nt">-b</span> &lt;MAC-ADDRESS&gt; <span class="nt">-t</span> random <span class="nt">--primary</span>
</code></pre></div></div> <h4 id="list-characteristics">List characteristics</h4> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gatttool <span class="nt">-b</span> &lt;MAC-ADDRESS&gt; <span class="nt">-t</span> random <span class="nt">--characteristics</span>
</code></pre></div></div> <h4 id="auth-and-notifications">Auth and notifications</h4> <ul> <li>Authentication is same as MiBand2</li> <li> <p>Services &amp; Characteristics of interest (names are arbitrary)</p> <ul> <li> <code class="language-plaintext highlighter-rouge">SERVICE_MIBAND1 : "0000fee1-0000-1000-8000-00805f9b34fb"</code> <ul> <li><code class="language-plaintext highlighter-rouge">CHARACTERISTIC_SENSOR_CONTROL : "00000001-0000-3512-2118-0009af100700"</code></li> <li><code class="language-plaintext highlighter-rouge">CHARACTERISTIC_SENSOR_MEASURE : "00000002-0000-3512-2118-0009af100700"</code></li> </ul> </li> </ul> </li> <li>To receive accelerometer notification <ul> <li>Write without response <code class="language-plaintext highlighter-rouge">0x010119</code> to service <code class="language-plaintext highlighter-rouge">0000fee1-0000-1000-8000-00805f9b34fb</code> characeteristic <code class="language-plaintext highlighter-rouge">00000001-0000-3512-2118-0009af100700</code> </li> <li>Write without response <code class="language-plaintext highlighter-rouge">0x02</code> to service <code class="language-plaintext highlighter-rouge">0000fee1-0000-1000-8000-00805f9b34fb</code> characeteristic <code class="language-plaintext highlighter-rouge">00000001-0000-3512-2118-0009af100700</code> </li> <li>Write <code class="language-plaintext highlighter-rouge">0x0100</code> to notification descriptor to enable notification</li> </ul> </li> </ul> <h3 id="2-processing-accelerometer-data">2. Processing Accelerometer Data</h3> <p>After successfully reading the raw accelerometer data, the next step would be to make sense of it.</p> <h4 id="parsing">Parsing</h4> <p>The data is received in packets of byte size <code class="language-plaintext highlighter-rouge">20</code>, <code class="language-plaintext highlighter-rouge">14</code> or <code class="language-plaintext highlighter-rouge">8</code>.</p> <p>Sample: <code class="language-plaintext highlighter-rouge">0x0100 0500 8200 0b00 0400 8000 0b00 0300 8100 0b00</code></p> <table> <thead> <tr> <th style="text-align: center">0100</th> <th style="text-align: center">0500</th> <th style="text-align: center">8200</th> <th style="text-align: center">0b00</th> <th style="text-align: center">0400</th> <th style="text-align: center">8000</th> <th style="text-align: center">0b00</th> <th style="text-align: center">0300</th> <th style="text-align: center">8100</th> <th style="text-align: center">0b00</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">-</td> <td style="text-align: center">signed x</td> <td style="text-align: center">signed y</td> <td style="text-align: center">signed z</td> <td style="text-align: center">signed x</td> <td style="text-align: center">signed y</td> <td style="text-align: center">signed z</td> <td style="text-align: center">signed x</td> <td style="text-align: center">signed y</td> <td style="text-align: center">signed z</td> </tr> </tbody> </table> <p>Parsing of raw data is performed by the method <code class="language-plaintext highlighter-rouge">_parse_raw_accel()</code>.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_parse_raw_accel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">)):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">'hhh'</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">6</span><span class="p">:</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">6</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">accel_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Full</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">accel_queue</span><span class="p">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">accel_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span></code></pre></figure> <p><a href="#L147">view on github</a></p> <h4 id="calculating-roll-and-pitch">Calculating Roll and Pitch</h4> <p>In the absence of linear acceleration, the accelerometer output is a measurement of the rotated gravitational field vector and can be used to determine the accelerometer pitch and roll orientation angles. The following equations are used to calculate the roll and pitch from the 3 linear accelerations.</p> <div class="box"> $$tan\phi_{xyz} = \left ( \frac{G_{py}} {G_{pz}} \right )$$ $$tan\theta_{xyz} = \left ( \frac{-G_{px}} {\sqrt{G_{py}^{2} + G_{pz}^{2}}} \right )$$ </div> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">roll</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">gy</span><span class="p">,</span> <span class="n">gz</span><span class="p">)</span>
<span class="n">pitch</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">gx</span><span class="p">,</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">gy</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">gz</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span></code></pre></figure> <p><a href="#L267">view on github</a></p> <h4 id="plot">Plot</h4> <p><a href="">Jupyter Notebook</a></p> <div class="image main"> <img src="" width="1200"> </div> <h3 id="3-sources--references">3. Sources &amp; References</h3> <p>[1] <a href="https://github.com/leojrfs/miband2" target="_blank" rel="noopener noreferrer">Base lib provided by Leo Soares</a></p> <p>[2] <a href="https://github.com/vshymanskyy/miband2-python-test" target="_blank" rel="noopener noreferrer">Volodymyr Shymanskyy</a></p> <p>[3] <a href="https://github.com/Freeyourgadget/Gadgetbridge/tree/master/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/miband2" target="_blank" rel="noopener noreferrer">Freeyourgadget Team</a></p> <p>[4] <a href="https://github.com/Freeyourgadget/Gadgetbridge/issues/63#issuecomment-493740447" target="_blank" rel="noopener noreferrer">ragcsaloâ€™s Comment</a></p> <p>[5] <a href="http://changy-.github.io/articles/xiao-mi-band-protocol-analyze.html" target="_blank" rel="noopener noreferrer">Xiaomi band protocol analyze</a></p> <p>[6] <a href="https://www.nxp.com/docs/en/application-note/AN3461.pdf" target="_blank" rel="noopener noreferrer">Tilt Sensing Using 3-Axis Accelerometer</a></p> <p>[7] <a href="https://github.com/creotiv/MiBand2#donate" target="_blank" rel="noopener noreferrer">creotiv donate link</a></p> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> Â© Copyright 2022 Sreejith Sasidharan. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>